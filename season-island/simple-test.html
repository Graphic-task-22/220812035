<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化测试 - 四季海岛</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 300px;
        }
        .status {
            margin: 10px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        #gameContainer {
            width: 100%;
            height: 100vh;
        }
        .controls {
            margin-top: 10px;
        }
        .control-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>简化测试</h3>
        <div id="status">正在初始化...</div>
        <div class="controls">
            <button class="control-btn" onclick="resetPlayer()">重置位置</button>
            <button class="control-btn" onclick="toggleDebug()">切换调试</button>
            <button class="control-btn" onclick="showInfo()">显示信息</button>
        </div>
        <div id="debugInfo"></div>
    </div>

    <div id="gameContainer"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        let scene, camera, renderer, player, island;
        let keys = {};
        let playerVelocity = new THREE.Vector3();
        let playerOnGround = false;
        let debugMode = false;
        
        // 初始化场景
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 2.5);
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('gameContainer').appendChild(renderer.domElement);
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 创建地面
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // 设置事件监听
            setupEventListeners();
            
            // 加载模型
            loadModels();
            
            // 开始渲染
            animate();
        }
        
        // 设置事件监听
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (debugMode) console.log('按键按下:', e.code);
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        // 加载模型
        async function loadModels() {
            updateStatus('正在加载角色模型...', 'warning');
            
            try {
                // 加载角色
                const playerLoader = new GLTFLoader();
                const playerGlb = await new Promise((resolve, reject) => {
                    playerLoader.load('./src/models/Assets/role.glb', resolve, undefined, reject);
                });
                
                player = playerGlb.scene;
                player.scale.set(0.5, 0.5, 0.5);
                player.position.set(0, 1, 0);
                player.traverse(child => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                scene.add(player);
                
                updateStatus('角色模型加载成功', 'success');
                
                // 加载海岛
                updateStatus('正在加载海岛模型...', 'warning');
                const islandLoader = new GLTFLoader();
                const islandGlb = await new Promise((resolve, reject) => {
                    islandLoader.load('./src/models/statan/shatan.glb', resolve, undefined, reject);
                });
                
                island = islandGlb.scene;
                island.scale.set(20, 20, 20);
                island.position.set(0, -1, 0);
                island.traverse(child => {
                    if (child.isMesh) {
                        child.receiveShadow = true;
                        child.castShadow = true;
                    }
                });
                scene.add(island);
                
                updateStatus('所有模型加载完成', 'success');
                
            } catch (error) {
                console.error('模型加载失败:', error);
                updateStatus('模型加载失败: ' + error.message, 'error');
            }
        }
        
        // 更新状态显示
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(message);
        }
        
        // 处理角色移动
        function handlePlayerMovement(deltaTime) {
            if (!player) return;
            
            const speed = 5;
            const gravity = 20;
            
            // 获取输入
            const moveForward = keys['KeyW'] || false;
            const moveBackward = keys['KeyS'] || false;
            const moveLeft = keys['KeyA'] || false;
            const moveRight = keys['KeyD'] || false;
            
            // 计算移动方向
            const direction = new THREE.Vector3();
            if (moveForward) direction.z -= 1;
            if (moveBackward) direction.z += 1;
            if (moveLeft) direction.x -= 1;
            if (moveRight) direction.x += 1;
            
            if (direction.length() > 0) {
                direction.normalize();
                playerVelocity.x = direction.x * speed;
                playerVelocity.z = direction.z * speed;
                
                // 更新朝向
                const angle = Math.atan2(direction.x, direction.z);
                player.rotation.y = angle;
            } else {
                playerVelocity.x = 0;
                playerVelocity.z = 0;
            }
            
            // 应用重力
            if (!playerOnGround) {
                playerVelocity.y -= gravity * deltaTime;
            }
            
            // 更新位置
            player.position.x += playerVelocity.x * deltaTime;
            player.position.y += playerVelocity.y * deltaTime;
            player.position.z += playerVelocity.z * deltaTime;
            
            // 简单的地面检测
            if (player.position.y < 1) {
                player.position.y = 1;
                playerVelocity.y = 0;
                playerOnGround = true;
            } else {
                playerOnGround = false;
            }
            
            // 更新相机
            const cameraOffset = new THREE.Vector3(0, 0.8, 2);
            const targetPosition = player.position.clone().add(cameraOffset);
            camera.position.lerp(targetPosition, 0.1);
            camera.lookAt(player.position);
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = 1/60; // 固定时间步长
            handlePlayerMovement(deltaTime);
            
            renderer.render(scene, camera);
        }
        
        // 全局函数
        window.resetPlayer = function() {
            if (player) {
                player.position.set(0, 1, 0);
                playerVelocity.set(0, 0, 0);
                console.log('角色位置已重置');
            }
        };
        
        window.toggleDebug = function() {
            debugMode = !debugMode;
            console.log('调试模式:', debugMode ? '开启' : '关闭');
        };
        
        window.showInfo = function() {
            if (player) {
                const info = {
                    position: player.position.toArray(),
                    rotation: player.rotation.toArray(),
                    onGround: playerOnGround,
                    velocity: playerVelocity.toArray()
                };
                console.log('角色信息:', info);
                
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `
                    <h4>角色信息:</h4>
                    <p>位置: [${info.position.map(v => v.toFixed(2)).join(', ')}]</p>
                    <p>旋转: [${info.rotation.map(v => v.toFixed(2)).join(', ')}]</p>
                    <p>在地面: ${info.onGround}</p>
                    <p>速度: [${info.velocity.map(v => v.toFixed(2)).join(', ')}]</p>
                `;
            }
        };
        
        // 启动
        init();
    </script>
</body>
</html> 